# -----------------------------------------------------------------------------
# Stage 1: build console frontend (dist not committed in repo).
# -----------------------------------------------------------------------------
FROM agentscope-registry.ap-southeast-1.cr.aliyuncs.com/agentscope/node:slim AS console-builder
WORKDIR /app
COPY console /app/console
RUN cd /app/console && npm ci --include=dev && npm run build

# -----------------------------------------------------------------------------
# Stage 2: runtime image with Python, Chromium, and app.
# -----------------------------------------------------------------------------
FROM agentscope-registry.ap-southeast-1.cr.aliyuncs.com/agentscope/node:slim

# ENV variables
ENV NODE_ENV=production
ENV WORKSPACE_DIR=/mnt/workspace
ENV COPAW_WORKING_DIR=/mnt/workspace/working

# Available channels for this image (imessage & discord excluded).
# Override at runtime with -e COPAW_ENABLED_CHANNELS=... if needed.
ARG COPAW_ENABLED_CHANNELS="dingtalk,feishu,qq,console"
ENV COPAW_ENABLED_CHANNELS=${COPAW_ENABLED_CHANNELS}

ARG DEBIAN_FRONTEND=noninteractive

# Fix GPG signature issues: refresh expired keyring from base image
RUN rm -rf /var/lib/apt/lists/* \
  && apt-get clean \
  && apt-get update -o Acquire::AllowInsecureRepositories=true \
  && apt-get install -y --allow-unauthenticated debian-archive-keyring \
  && apt-get update && apt-get install -y --fix-missing \
    curl  \
    python3  \
    python3-pip  \
    python3-venv \
    build-essential  \
    libssl-dev  \
    git  \
    supervisor  \
    vim  \
    gettext-base \
    xfce4 \
    xfce4-terminal \
    xvfb \
    dbus-x11 \
    fonts-wqy-zenhei \
    fonts-wqy-microhei \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean


RUN apt-get update && apt-get install -y --fix-missing \
    chromium \
    chromium-sandbox \
    libx11-xcb1 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxi6 \
    libxtst6 \
    libnss3 \
    libglib2.0-0 \
    libdrm2 \
    libgbm1 \
    libasound2 \
    fonts-liberation \
    libu2f-udev \
  && rm -rf /var/lib/apt/lists/* \
  && apt-get clean


RUN sed -i 's/^CHROMIUM_FLAGS=""/CHROMIUM_FLAGS="--no-sandbox"/' /usr/bin/chromium

# Install copaw under /app (persistent in image, not affected by volume mounts)
WORKDIR /app

RUN python3 -m venv /app/venv
ENV PATH="/app/venv/bin:$PATH"

COPY pyproject.toml setup.py README.md ./
COPY src ./src
# Inject console dist from build stage (repo does not commit dist).
COPY --from=console-builder /app/console/dist/ ./src/copaw/console/
RUN pip install --no-cache-dir .

# Working data directory (may be mounted as a volume at runtime)
WORKDIR ${WORKSPACE_DIR}

COPY deploy/config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf

EXPOSE 7860

# Init working dir at container start (volume may be empty), then launch supervisord.
CMD copaw init --defaults --accept-security && /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf
